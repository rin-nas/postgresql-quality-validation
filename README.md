# ✅ Валидатор схемы БД PostgreSQL

## Цели

1. Автоматизация инспекций миграций БД. 
1. Поддержание заданного уровня качества БД: скорости работы SQL запросов c целостностью данных и наличия документации.

## Применение

* Валидация схемы БД при автоматическом тестировании наката-отката миграций БД в CI/CD


## Описание работы

Валидатор представляет из себя функцию для БД PostgreSQL 12+.

Настройки хранятся в таблице `db_validation.schema_validate_config`. 

Запуск:

```sql
select db_validation.schema_validate();
```

Функция проверяет в текущей БД объекты БД (таблицы и др.) на наличие проблем. Никаких данных не возвращается. 
Если проблемы не найдены, функция успешно завершает работу, иначе возвращается ошибка (исключение в терминах PL/PgSQL): текст ошибки и рекомендации по исправлению.

Рекомендуется вызвать функцию в одной транзакции до и после выполнения миграций на тестовой БД. 
Если до выполнения миграций ошибок нет, а после имеются, значит причина в миграции БД.

## Проверки

<table class="relative-table wrapped" style="width: 100.0%;">
    <colgroup><col /><col /><col style="width: 16.2491%;" /><col style="width: 17.7945%;" /><col style="width: 51.5393%;" /></colgroup>
<tbody>
<tr>
    <th class="numberingColumn">№</th>
    <th colspan="1">В какой версии сделано</th>
    <th colspan="1">Код проверки</th>
    <th>Название проверки</th>
    <th>Назначение (обоснование) проверки</th>
</tr>
<tr>
    <td class="numberingColumn">1</td>
    <td colspan="1">v1</td>
    <td colspan="1"><code>has_pk_uk</code></td>
    <td>
        <p>Наличие первичного или уникального индекса в таблице</p>
    </td>
    <td>
        <p>Первичный индекс (PK) позволяет</p>
        <ul>
            <li>однозначно идентифицировать запись таблицы БД</li>
            <li>получить очень быстрый доступ к записи</li>
        </ul>
        <p>Уникальный индекс (UK) позволяет исключить дубликаты.</p>
        <p>Без PK или UK невозможно сделать логическую репликацию.</p>
    </td>
</tr>
<tr>
    <td class="numberingColumn">2</td>
    <td colspan="1">v1</td>
    <td colspan="1"><code>has_not_redundant_index</code></td>
    <td>
        <p>Отсутствие избыточных индексов в таблице</p></td>
    <td>
    <p>Если есть составной индекс на поля col1 и col2 (именно в такой последовательности), то отдельный индекс на поле col1 не нужен, он <span style="letter-spacing: 0.0px;">избыточный. Лишние индексы занимают место на диске и замедляют DML запросы.</span></p></td>
</tr>
<tr>
    <td class="numberingColumn">3</td>
    <td colspan="1">v2</td>
    <td colspan="1"><code>has_index_for_fk</code></td>
    <td colspan="1">
    <p>Наличие индексов для ограничений внешних ключей в таблице</p></td>
    <td colspan="1">Без индексов на ограничения внешних ключей (FK) могут работать медленно элементарные запросы типа <strong><code>DELETE FROM {table} WHERE id=&lt;id&gt;</code></strong> из-за ссылающихся на <code>{table}</code> таблиц по FK без индекса.</td>
</tr>
<tr>
    <td class="numberingColumn">4</td>
    <td colspan="1">v2</td>
    <td colspan="1"><code>has_table_comment</code></td>
    <td colspan="1">Наличие описания для таблицы</td>
    <td colspan="1">На этапе проектирования описание помогает лучше понять назначение таблицы и на сколько удачно она названа исходя из описания.
                    В дальнейшем тандем названия и описания упрощают понимание и поддержку кода. Порог входа для новых IT специалистов (разработчиков, тестировщиков, бизнес- и системных аналитиков) уменьшается.
                    Значение в <strong><code>COMMENT ON TABLE {table}</code></strong> не должно быть пустым и не должно совпадать с названием таблицы.
                    Таблицы-секции из проверки исключаются.
    </td>
</tr>
<tr>
    <td class="numberingColumn">5</td>
    <td colspan="1">v2</td>
    <td colspan="1"><code>has_column_comment</code></td>
    <td colspan="1">Наличие описания для колонки</td>
    <td colspan="1">На этапе проектирования описание помогает лучше понять назначение колонки и на сколько удачно она названа исходя из описания.
                    В дальнейшем тандем названия и описания упрощают понимание и поддержку кода. Порог входа для новых IT специалистов (разработчиков, тестировщиков, бизнес- и системных аналитиков) уменьшается.
                    Значение в <strong><code>COMMENT ON TABLE {table}.{column}</code></strong> не должно быть пустым и не должно совпадать с названием колонки.
                    Колонки с названием <strong><code>id</code></strong> из проверки исключаются.
                    Таблицы-секции из проверки исключаются.
    </td>
</tr>
</tbody>
</table>

![visitors](https://visitor-badge.glitch.me/badge?page_id=github.com/rin-nas/postgresql-patterns-library/db_validate.md)
