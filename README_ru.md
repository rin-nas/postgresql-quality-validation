# ✅ Валидатор качества схемы БД PostgreSQL

## Цели

1. Автоматизация инспекций миграций БД. 
1. Поддержание заданного уровня качества БД: скорости работы SQL запросов c целостностью данных и наличия документации.

## Применение

* Валидация схемы БД при ручном или автоматическом тестировании наката-отката миграций БД в CI/CD


## Описание работы

Валидатор представляет из себя функцию для БД PostgreSQL 12+.

Настройки хранятся в таблице `db_validation.schema_validate_config`. 

Запуск:

```sql
select db_validation.schema_validate();
```

Функция проверяет в текущей БД объекты БД (таблицы и др.) на наличие ошибок. Никаких данных не возвращается. 
Если проблемы не найдены, функция успешно завершает работу, иначе возвращается ошибка (исключение в терминах PL/PgSQL): текст ошибки и рекомендации по исправлению.

Можно запускать функцию в одной транзакции 2 раза: до и после выполнения миграций на тестовой БД.
Если до выполнения миграций ошибок нет, а после имеются, значит проблема в миграции БД.
Так же можно запускать функцию только по одному разу после наката и отката миграции.

## Проверки

### has_pk_uk

Наличие первичного или уникального индекса в таблице.

Первичный индекс (PK) позволяет:

* однозначно идентифицировать запись таблицы БД
* получить очень быстрый доступ к записи

Уникальный индекс (UK) позволяет исключить дубликаты. 
Без PK или UK невозможно сделать логическую репликацию.

### has_not_redundant_index

Отсутствие избыточных индексов в таблице.

Если есть составной индекс на поля col1 и col2 (именно в такой последовательности), то отдельный индекс на поле col1 не нужен, он избыточный. 
Лишние индексы занимают место на диске и замедляют DML запросы.

### has_index_for_fk

Наличие индексов для ограничений внешних ключей в таблице.

Без индексов на ограничения внешних ключей (FK) могут работать медленно элементарные запросы типа 
`DELETE FROM {table} WHERE id=<id>` из-за ссылающихся на `{table}` таблиц по FK без индекса.

### has_table_comment

Наличие описания для таблицы.

На этапе проектирования описание помогает лучше понять назначение таблицы и на сколько удачно она названа исходя из описания. 
В дальнейшем тандем названия и описания упрощают понимание и поддержку кода. 
Порог входа для новых IT специалистов (разработчиков, тестировщиков, бизнес- и системных аналитиков) уменьшается. 
Значение в `COMMENT ON TABLE {table}` не должно быть пустым и не должно совпадать с названием таблицы. 
Таблицы-секции из проверки исключаются. 

### has_column_comment

Наличие описания для колонки.

На этапе проектирования описание помогает лучше понять назначение колонки и на сколько удачно она названа исходя из описания. 
В дальнейшем тандем названия и описания упрощают понимание и поддержку кода. 
Порог входа для новых IT специалистов (разработчиков, тестировщиков, бизнес- и системных аналитиков) уменьшается. 
Значение в `COMMENT ON TABLE {table}.{column}` не должно быть пустым и не должно совпадать с названием колонки. 
Колонки с названием `id` из проверки исключаются. 
Таблицы-секции из проверки исключаются. 
