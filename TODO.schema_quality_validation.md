# TODO –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ —Å—Ö–µ–º—ã –ë–î

1. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥
   1. ‚úÖ –í—ã–Ω–µ—Å—Ç–∏ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ö–µ–º—É `db_validation`, –∞ —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –≤ `schema_validate()`. 
   1. ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å–ª—É–∂–µ–±–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ `db_validation.schema_validate_config`.
   1. –†–∞—Å–ø–∏–ª–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ç–æ—Ä –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ view / —Ñ—É–Ω–∫—Ü–∏–∏.
1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏ (–Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –∫–æ–Ω—Ñ–∏–≥)
   1. üö® –î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö, –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –∏ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –ë–î (–¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü—ã –∏ –∫–æ–ª–æ–Ω–∫–∏) –¥–ª—è –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
      –î–ª—è —ç—Ç–æ–≥–æ –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `select db_validation.schema_validate_prepare()`,
      –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –ë–î –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É (—Ç–∞–±–ª–∏—Ü–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏).
   1. üö® –î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–æ–±–ª–µ–º –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü—ã –∏–ª–∏ –æ—à–∏–±–∫—É. –ü—É—Å—Ç–∞—è —Ç–∞–±–ª–∏—Ü–∞ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤—Å—ë –æ–∫.
   1. –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ç–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞, –¥–ª—è —ç—Ç–æ–≥–æ —Å–¥–µ–ª–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ö–µ–º—É `db_validation_test`.
   1. –î–æ–±–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É `schema_validate_config` –∫–æ–ª–æ–Ω–∫–∏ (–Ω–æ–≤—ã–µ –æ–ø—Ü–∏–∏):   
      ```sql
      views_ignore_regexp  text check ( views_ignore_regexp != ''
                                        and trim(views_ignore_regexp) = views_ignore_regexp
                                        and db_validation.is_regexp(views_ignore_regexp) ),
      views_ignore         regclass[],
      --table_columns_ignore db_validation.table_column[], --—Å–º. –¥–æ–º–µ–Ω public.table_column 
      --view_columns_ignore  db_validation.view_column[],  --—Å–º. –¥–æ–º–µ–Ω public.view_column
      
      table_columns_invalid_name_ignore db_validation.table_column[], --—Å–º. –¥–æ–º–µ–Ω public.table_column
      view_columns_invalid_name_ignore  db_validation.view_column[],  --—Å–º. –¥–æ–º–µ–Ω public.view_column
      ```
      –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —ç—Ç–∏—Ö –æ–ø—Ü–∏–π –≤ `schema_validate()` –≤ –∫–∞–∂–¥—É—é –ø—Ä–æ–≤–µ—Ä–∫—É.
   1. –¢–∞–±–ª–∏—Ü—É `schema_validate_config` –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å?
      –ö–æ–ª–æ–Ω–∫–∏: check, compare (validate, ignore), 
               schema, schema_regexp, 
               table, table_regexp, 
               view, view_regexp,
               table_column, table_column_regexp,
               view_column, view_column_regexp, ...  
1. –û–ø–∏—Å–∞–Ω–∏—è (–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏) –æ–±—ä–µ–∫—Ç–æ–≤ –ë–î (`COMMENT ON ...`)
   1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞–ª–∏—á–∏—è [–æ–ø–∏—Å–∞–Ω–∏—è](https://www.postgrespro.ru/docs/postgresql/12/sql-comment) –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤ –ë–î: —Å—Ö–µ–º—ã, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è, —Ñ—É–Ω–∫—Ü–∏–∏, –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, —Ç—Ä–∏–≥–≥–µ—Ä—ã, —Ç–∏–ø—ã, –¥–æ–º–µ–Ω—ã, —Ä–æ–ª–∏. 
      –í –º–∏–≥—Ä–∞—Ü–∏—è—Ö –ë–î –∑–∞–±—ã–≤–∞—é—Ç —ç—Ç–æ –¥–µ–ª–∞—Ç—å.
   1. –û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º –∏ –Ω–µ –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –æ–±—ä–µ–∫—Ç–∞ –ë–î.
      –û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∏–º–µ—Ç—å –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–æ—á–Ω—É—é (–±–æ–ª—å—à—É—é) –±—É–∫–≤—É. –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ç–∞–∫: `{comment} != lower({comment})`
   1. –í –æ–¥–Ω–æ–π –ë–î –æ–ø–∏—Å–∞–Ω–∏—è –≤—Å–µ—Ö —Å—Ö–µ–º –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º (`is_schema_comment_unique`).
   1. –í –æ–¥–Ω–æ–π —Å—Ö–µ–º–µ –æ–ø–∏—Å–∞–Ω–∏—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º (`is_table_comment_unique`). 
   1. –í –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ –æ–ø–∏—Å–∞–Ω–∏—è –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º (`is_table_column_comment_unique`).
1. –ù–∞–∑–≤–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ –ë–î
   1. üö® –ù–∞–∑–≤–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ –ë–î (‚úÖ —Å—Ö–µ–º—ã, ‚úÖ —Ç–∞–±–ª–∏—Ü—ã, ‚úÖ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è, ‚úÖ –∫–æ–ª–æ–Ω–∫–∏, ‚úÖ —Ñ—É–Ω–∫—Ü–∏–∏, ‚úÖ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, ‚úÖ —Ç—Ä–∏–≥–≥–µ—Ä—ã, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, —Ç–∏–ø—ã, –¥–æ–º–µ–Ω—ã, —Ä–æ–ª–∏) 
      –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å, —Ç–∏—Ä–µ: `select '{column}' ~ '^[a-z][a-z\d_\-]*[a-z\d]$';`.
      –ù–∞–∑–≤–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ –ë–î –¥.–±. —Ç–æ–ª—å–∫–æ –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ (Postgres makes everything lower case unless you double quote it).
      –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥ 2 —Ä–µ–≥—É–ª—è—Ä–∫–∏, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü –∏ –∫–æ–ª–æ–Ω–æ–∫.
      –ë—ã–ª —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∫–æ–ª–æ–Ω–∫–∏ –Ω–µ –∑–∞–º–µ—Ç–∏–ª–∏ —Ä—É—Å—Å–∫—É—é –±—É–∫–≤—É "c".
   1. üö® –ù–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ –ë–î –ù–ï –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–∏–ø–æ–≤ –≤ –ë–î (—ç—Ç–æ –ø–ª–æ—Ö–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞). –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—É—Ç—å.
      ```sql
        --explain
        with wrong_names as materialized (
            SELECT unnest(array_cat(
                            array_agg(typname)::text[],
                            array_agg(sql_name) filter (where sql_name is not null)
                          )) as types
            FROM pg_type
            LEFT JOIN format_type(oid, NULL::integer) AS f(sql_name)
                   ON sql_name !~ '[" ]' AND sql_name != typname
            WHERE true
              AND typname != 'name'
              AND typtype = 'b'
              AND typarray != 0
              AND typcategory NOT IN ('E', 'A')
        )
        --table wrong_names; --–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        select row_number() over (order by t.table_schema, t.table_name, c.column_name),
               t.table_type,
               concat(t.table_schema, '.', t.table_name, '.', c.column_name) as wrong_column_name,
               c.data_type,
               c.udt_name
        from information_schema.columns as c
        inner join information_schema.tables as t on t.table_schema = c.table_schema
                                                 and t.table_name = c.table_name
                                                 and t.table_type in ('BASE TABLE', 'VIEW')
        where true
          and t.table_schema not in ('pg_catalog', 'migration', 'test')
          and t.table_name !~ 'pg_'
          --and column_name = udt_name
          and c.column_name in (table wrong_names)
        order by wrong_column_name;
      ```
   1. –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –Ω–µ—Å–æ—Å—Ç–∞–≤–Ω–æ–≥–æ –∫–ª—é—á–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω—É —Ä–µ–≥. –≤—ã—Ä–∞–∂–µ–Ω–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ `id` –∏–ª–∏ `guid` (—Å–¥–µ–ª–∞—Ç—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º)
   1. –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ `guid` –¥–æ–ª–∂–Ω–æ –∏–º–µ—Ç—å —Ç–∏–ø `uuid` (—Å–¥–µ–ª–∞—Ç—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º)
      –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ `ids` –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º (—Å–¥–µ–ª–∞—Ç—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º)
   1. –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ —Å FK –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —á–∞—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –∏–∑ FK. –ü—Ä–∏–º–µ—Ä –¥–ª—è `author integer REFERENCES test.forum__user (id) on delete set null` –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `author_id`
   1. –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∏–ª–∏ –∫–æ–ª–æ–Ω–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è –Ω–∞ `id_`, –æ–Ω–æ –º–æ–∂–µ—Ç —Ç–∞–∫ –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è (—Å–¥–µ–ª–∞—Ç—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º)
   1. –ù–∞–∑–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü —Ç–∏–ø–∞ reviewed_resume –¥.–±. –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏, –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ –¥.–±. —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º, –∞ –Ω–µ –≥–ª–∞–≥–æ–ª–æ–º
   1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –ø–æ —à–∞–±–ª–æ–Ω—É `{table}_{column}_seq` (—Å–¥–µ–ª–∞—Ç—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º). –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏ –∑–∞–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –Ω–∞ —ç—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏—è. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `pg_get_serial_sequence('{table}', '{column}')`
   1. –í–∑—è—Ç—å —Å–æ–≥–ª–∞—à–µ–Ω–∏—è –ø–æ –∏–º–µ–Ω–æ–≤–∞–Ω–∏—é –∏–∑ [API](https://wiki.rabota.space/pages/viewpage.action?pageId=25789378), —Å–º. –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑–¥–µ–ª
1. –ù–∞–∑–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ `enum`
   1. –í–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ `enum` –Ω–∞–∑–≤–∞–Ω–∏—è –µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥.–±. –≤ –µ–¥–∏–Ω–æ–º —Å—Ç–∏–ª–µ. –ü—Ä–∏–º–µ—Ä: `has_pk_uk` (snake case) –∏–ª–∏ `has-pk-uk` (kebab case) –∏–ª–∏ `hasPkUk` (camel case) –∏–ª–∏ `HasPkUk` (pascal case).
   1. –î–ª—è –≤—Å–µ–π –ë–î –≤ `enum` –Ω–∞–∑–≤–∞–Ω–∏—è –∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥.–±. –≤ –µ–¥–∏–Ω–æ–º —Å—Ç–∏–ª–µ.
1. –ò–Ω–¥–µ–∫—Å—ã
   1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö (–±–∏—Ç—ã—Ö) –∏–Ω–¥–µ–∫—Å–æ–≤. –°–µ–π—á–∞—Å –¥–ª—è —Ç–∞–∫–∏—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞ "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω–¥–µ–∫—Å –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –∫–ª—é—á–∞".
   1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø–æ–ª–Ω—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∏–Ω–¥–µ–∫—Å–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏.
   1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤, —á—Ç–æ–±—ã –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏ –∏–∑ –∏–Ω–¥–µ–∫—Å–∞ –±—ã–ª–∏ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º `NOT NULL`. –ò–Ω–∞—á–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å [–ø–æ –¥—Ä—É–≥–æ–º—É](https://github.com/rin-nas/postgresql-patterns-library/tree/master#%D0%BA%D0%B0%D0%BA-%D1%81%D0%B4%D0%B5%D0%BB%D0%B0%D1%82%D1%8C-%D1%81%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D0%BD%D0%BE%D0%B9-%D1%83%D0%BD%D0%B8%D0%BA%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B9-%D0%B8%D0%BD%D0%B4%D0%B5%D0%BA%D1%81-%D0%B3%D0%B4%D0%B5-%D0%BE%D0%B4%D0%BD%D0%BE-%D0%B8%D0%B7-%D0%BF%D0%BE%D0%BB%D0%B5%D0%B9-%D0%BC%D0%BE%D0%B6%D0%B5%D1%82-%D0%B1%D1%8B%D1%82%D1%8C-null).
   1. –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ `indexes_ignore_regexp`. –ü—Ä–∏–º–µ—Ä: `^pgcompact_index_\d+$`.
   1. –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å —É–¥–∞–ª—è—Ç—å –∏–Ω–¥–µ–∫—Å—ã —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –ø–æ –º–∞—Å–∫–µ `(_ccnew$|^pgcompact_index_\d+$)`, –∞ –Ω–µ –∏–Ω–¥–µ–∫—Å—ã —Å –¥—Ä—É–≥–∏–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
   1. B-–¥–µ—Ä–µ–≤—å—è –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ —Å–∫–∞–ª—è—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –î–ª—è –º–∞—Å—Å–∏–≤–æ–≤ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å GIN –∏–Ω–¥–µ–∫—Å –≤–º–µ—Å—Ç–æ btree.
   1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ –∏–∑–±—ã—Ç–æ—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å, –µ—Å–ª–∏ –¥–ª—è `field` –µ—Å—Ç—å `lower(field)`, `upper(field)`, `date(field)`. –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å —É–¥–∞–ª–∏—Ç—å –∏–Ω–¥–µ–∫—Å –Ω–∞ `field`!
   1. –û–±–Ω–∞—Ä—É–∂–∏–≤–∞—Ç—å (–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å —É–¥–∞–ª—è—Ç—å, –∞ –Ω–µ –≤—ã–¥–∞–≤–∞—Ç—å –æ—à–∏–±–∫—É) —Ç–∞–∫–∏–µ –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã:
      1. `CREATE UNIQUE INDEX ON paid_services.snapshot_package_limit USING btree (order_item_id, service_id, sort(uniq(zone_ids)))`
      1. `CREATE UNIQUE INDEX ON paid_services.snapshot_package_limit USING btree (order_item_id, service_id, zone_ids)`
1. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. –ö—Ä–æ–º–µ –æ—à–∏–±–æ–∫ –º–æ–∂–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
   1. –î–ª—è –∫–æ–ª–æ–Ω–æ–∫ —Ç–∏–ø–∞ `json[b]` —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –¥–µ–ª–∞—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–ª—è –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è.
   1. –í–∞–ª–∏–¥–∞—Ç–æ—Ä –¥–∞—ë—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –ø–æ —É–¥–∞–ª–µ–Ω–∏—é –∏–∑–±—ã—Ç–æ—á–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞. –ù—É–∂–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è?
      ```sql
      ERROR:  –¢–∞–±–ª–∏—Ü–∞ public.preset__currency —É–∂–µ –∏–º–µ–µ—Ç –∏–Ω–¥–µ–∫—Å CREATE UNIQUE INDEX preset__currency_id_uindex ON public.preset__currency USING btree (id)
      –£–¥–∞–ª–∏—Ç–µ –∏–∑–±—ã—Ç–æ—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å CREATE UNIQUE INDEX preset__currency_pk ON public.preset__currency USING btree (id)
      CONTEXT:  PL/pgSQL function db_validation.schema_validate() line 109 at RAISE 
      ```
1. –¢–∏–ø—ã –∫–æ–ª–æ–Ω–æ–∫
   1. ‚úÖ –í–º–µ—Å—Ç–æ —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ `CHAR(n) / VARCHAR(n)` –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `TEXT`
   1. ‚úÖ –í–º–µ—Å—Ç–æ —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ `TIMESTAMP` (WITHOUT TIME ZONE) –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `TIMESTAMPTZ` (TIMESTAMP WITH TIME ZONE) ([—Å—Ç–∞—Ç—å—è](https://habr.com/ru/articles/772954/))
   1. üö® –î–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ —Å —Ç–∏–ø–æ–º `TEXT` –∏ `VARCHAR` –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª–∏–Ω—ã –∏ —Å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è `check(...)` –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–µ–ª–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π `check(length(col) between X and Y)`
   1. –í–º–µ—Å—Ç–æ –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ `MONEY` –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `NUMERIC` ([—Å—Ç–∞—Ç—å—è](https://www.crunchydata.com/blog/working-with-money-in-postgres))
   1. –í–º–µ—Å—Ç–æ —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ `SERIAL` –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `[BIG]INT GENERATED`
   1. –í–º–µ—Å—Ç–æ `JSON` —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `JSONB`
   1. –í —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –Ω–µ–ª—å–∑—è –∑–∞–ø–∏—Å–∞—Ç—å `null` –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –Ω–∞ –≤—ã–±–æ—Ä (–∫–æ–≥–¥–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ç–∏–ø–∞ `check` –Ω–∞ –∫–æ–ª–æ–Ω–∫—É), –¥.–±. —Ç–æ–ª—å–∫–æ 1 —Å–ø–æ—Å–æ–±. 
      –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏: `alter table {table} add {column} varchar(10);`
   1. –î–ª—è –∫–æ–ª–æ–Ω–∫–∏ `updated_at` (–Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥–µ) –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ `now()` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏
6. –í–∑—è—Ç—å –∏–¥–µ–∏ –∏–∑ 
   1. [DBA: –Ω–∞—Ö–æ–¥–∏–º –±–µ—Å–ø–æ–ª–µ–∑–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã](https://habr.com/ru/company/tensor/blog/488104/)
   1. https://github.com/ankane/strong_migrations
   1. https://github.com/kristiandupont/schemalint/tree/master/src/rules
   1. https://github.com/IMRSVDataLabs/imrsv-schema-linter
   1. https://gitlab.com/depesz/pgWikiDont/-/tree/master/
   1. https://www.google.com/search?q=postgresq+schema+linter - –µ—â—ë —Å—Å—ã–ª–∫–∏ –∑–¥–µ—Å—å
1. –ó–∞–ø—Ä–µ—Ç–∏—Ç—å —É–¥–∞–ª—è—Ç—å —Ç–∞–±–ª–∏—Ü—ã –∏–∑ –≤—Å–µ—Ö —Å—Ö–µ–º, –∫—Ä–æ–º–µ `unused` –∏ `migration`. 
   –î–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∏—Å–∫–æ–≤ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞ —Ç–∞–±–ª–∏—Ü—É –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å (–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –æ–¥–Ω—É –∏–∑ –≤—ã—à–µ—É–∫–∞–∑–∞–Ω–Ω—ã—Ö —Å—Ö–µ–º), –∞ —É–∂–µ —á–µ—Ä–µ–∑ 1 –Ω–µ–¥–µ–ª—é —É–¥–∞–ª–∏—Ç—å.  
1. –ó–∞–ø—Ä–µ—Ç–∏—Ç—å —É–¥–∞–ª—è—Ç—å –∫–æ–ª–æ–Ω–∫–∏ –±–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –≤ `*_old`.
1. –û–±—ä–µ–∫—Ç—ã –ë–î –≤ –æ–¥–Ω–æ–π —Å—Ö–µ–º–µ –¥–æ–ª–∂–Ω—ã –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç—å –æ–¥–Ω–æ–º—É –≤–ª–∞–¥–µ–ª—å—Ü—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞), —Å–º. [`pg_object_owner.sql`](../../views/pg_object_owner.sql)
1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è –∑–∞–ø—Ä–µ—â–µ–Ω–∏—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤—Å—Ç–∞–≤–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü—É (–Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ `_log` –∏–ª–∏ `_history`) –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Å—Ç—Ä–æ–∫, –µ—Å–ª–∏ –µ—Å—Ç—å PK –Ω–∞ –∫–æ–ª–æ–Ω–∫—É id –∏ –Ω–µ—Ç UK –±–µ–∑ id. –í —ç—Ç–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–µ —É—á–∞—Å—Ç–≤—É—é—Ç –∫–æ–ª–æ–Ω–∫–∞ —Å PK, –∫–æ–ª–æ–Ω–∫–∏ —Å –¥–∞—Ç–æ–π, –¥–∞—Ç–æ–π-–≤—Ä–µ–º–µ–Ω–µ–º.
1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è https://github.com/okbob/plpgsql_check/
1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∏–≥–¥–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è. –ü—Ä–∏–º–µ—Ä: —É–¥–∞–ª–∏–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–ª —Ç—Ä–∏–≥–≥–µ—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é. –¢–µ–ø–µ—Ä—å —Ñ—É–Ω–∫—Ü–∏—è –Ω–∏–≥–¥–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.
1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —Ç–∞–±–ª–∏—Ü—ã (`has_not_duplicate_constraint`). 
   –ü—Ä–∏—á–∏–Ω—ã –ø–æ—è–≤–ª–µ–Ω–∏—è —Ç–∞–∫–∏—Ö –æ—à–∏–±–æ–∫:
   * –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –Ω–∞–∫–∞—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î, –µ—Å–ª–∏ –≤ –∫–æ–¥–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è; 
   * –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∫–æ–ª–æ–Ω–∫–∏, –≥–¥–µ –≤ `check(...)` –∑–∞–±—ã–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏. 
   ```sql
   with s as (
      SELECT s.conrelid                                                             as table_oid,
             array_length(array_agg(pg_get_constraintdef(s.oid, true)), 1)          as def_count,
             array_length(array_agg(distinct pg_get_constraintdef(s.oid, true)), 1) as def_uniq_count,
             array_agg(pg_get_constraintdef(s.oid, true))                           as def
      FROM pg_constraint as s
      WHERE connamespace::regnamespace not in ('pg_catalog', 'information_schema')
        AND s.conrelid != 0
      GROUP BY s.conrelid
   )
   select s.table_oid::regclass, t.*
   from s
   cross join lateral (
       select u.value,
              count(*) as duplicate_count
       from unnest(s.def) as u(value)
       group by u.value
       having count(*) > 1
   ) as t
   where def_count != def_uniq_count;
   ```
1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É: –µ—Å–ª–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –ø—Ä–æ—Ü–µ–Ω—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å–≤–æ–µ–≥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è > N%, —Ç–æ —Ä–µ–∫–æ–º–µ–Ω—Ç–æ–≤–∞—Ç—å —Å–º–µ–Ω–∏—Ç—å `int` –Ω–∞ `bigint`.
   –°—Å—ã–ª–∫–∏ –ø–æ —Ç–µ–º–µ: 
   [1](https://stackoverflow.com/questions/54795701/migrating-int-to-bigint-in-postgressql-without-any-downtime),
   [2](http://zemanta.github.io/2021/08/25/column-migration-from-int-to-bigint-in-postgresql/),
   [3](https://engineering.silverfin.com/pg-zero-downtime-bigint-migration/).
   ```sql
   select schemaname as schema,
          sequencename as sequence_name,
          data_type,
          used_percent
   from pg_sequences
   cross join round(last_value * 100.0 / max_value, 2) as used_percent
   where last_value is not null /*null means access denied*/ and used_percent > 33
   order by used_percent desc;
   ```
1. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏ –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã —Å–º–æ—Ç—Ä–∏—Ç—Å—è –ø–æ–Ω—è—Ç–Ω–µ–µ. –ü—Ä–∏–º–µ—Ä:
   ```sql
   CREATE TABLE test.test1
   (
       day_from int check(day_from >= 0 and coalesce(day_from, day_to) is not null),
       day_to   int check(day_to >= 0 AND day_from <= day_to)
   );
   --vs
   CREATE TABLE test.test1
   (
       day_from int check(day_from >= 0),
       day_to   int check(day_to >= 0), --—Ç—É—Ç –∑–∞–ø—è—Ç–∞—è!
       check (coalesce(day_from, day_to) is not null and day_from <= day_to)
   );
   -- TEST
   insert into test.test1 values (null, null); --error
   insert into test.test1 values (1, null); --ok
   insert into test.test1 values (null, 1); --ok
   insert into test.test1 values (1, 2); --ok
   insert into test.test1 values (2, 1); --error
   ```
